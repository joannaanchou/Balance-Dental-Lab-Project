<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>牙醫假牙管理系統｜登入</title>

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

  <!-- 全站樣式（沿用 home.html） -->
  <link rel="stylesheet" href="styles.css">

  <style>
    :root {
      --brand-deep: #233446;
      --brand-mid: #2f4a63;
      --brand-accent: #0ea5a5;
      --brand-soft: #e6eef5;
    }

    body {
      font-family: "Noto Sans TC", "Microsoft JhengHei", system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      min-height: 100vh;
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(14, 165, 165, .08), transparent 60%),
        radial-gradient(800px 500px at 110% 110%, rgba(35, 52, 70, .14), transparent 60%),
        linear-gradient(180deg, var(--brand-soft) 0%, #f7fafc 100%);
      color: #0f172a;
    }

    .auth-wrap {
      min-height: 100vh;
      display: grid;
      place-items: center;
      padding: 32px 16px;
    }

    .auth-card {
      border: 0;
      border-radius: 20px;
      background: #fff;
      box-shadow: 0 10px 24px rgba(23, 42, 69, .06), 0 22px 60px rgba(23, 42, 69, .10);
      overflow: hidden;
    }

    .auth-head {
      padding: 20px 24px 16px;
      border-bottom: 1px solid #eef2f7;
      background: linear-gradient(135deg, rgba(14, 165, 165, .10), rgba(14, 165, 165, 0));
    }

    .brand-badge {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      display: grid;
      place-items: center;
      font-weight: 800;
      color: #003b3b;
      background: linear-gradient(135deg, var(--brand-accent), #22d3d3);
      box-shadow: 0 6px 16px rgba(14, 165, 165, .25);
    }

    .brand-title {
      font-weight: 800;
      letter-spacing: .02em;
      color: #0b2b3f;
    }

    .brand-sub {
      color: #64748b;
      font-size: .95rem;
    }

    .auth-body {
      padding: 22px 24px 24px;
    }

    .auth-body .form-label {
      font-weight: 700;
      color: #0b2b3f;
    }

    .form-control:focus {
      border-color: rgba(14, 165, 165, .6);
      box-shadow: 0 0 0 .2rem rgba(14, 165, 165, .15);
    }

    .btn-brand {
      --bs-btn-bg: var(--brand-accent);
      --bs-btn-border-color: var(--brand-accent);
      --bs-btn-hover-bg: #0a8c8c;
      --bs-btn-hover-border-color: #0a8c8c;
      --bs-btn-active-bg: #086e6e;
      --bs-btn-active-border-color: #086e6e;
      color: #fff !important;
      border-radius: 12px;
      padding: .7rem 1rem;
      font-weight: 700;
      letter-spacing: .02em;
    }

    .btn-outline-brand {
      --bs-btn-color: var(--brand-accent);
      --bs-btn-border-color: rgba(14, 165, 165, .4);
      --bs-btn-hover-color: #fff;
      --bs-btn-hover-bg: var(--brand-accent);
      --bs-btn-hover-border-color: var(--brand-accent);
      border-radius: 12px;
      padding: .6rem .9rem;
      font-weight: 700;
    }

    .muted-link {
      color: var(--brand-mid);
      text-decoration: none;
      font-weight: 700;
    }

    .muted-link:hover {
      color: var(--brand-accent);
    }

    .alert {
      border-radius: 12px;
    }

    .clock {
      color: #64748b;
    }

    .auth-container {
      width: min(560px, 100%);
    }
  </style>
</head>

<body>
  <div id="app" class="auth-wrap">
    <div class="auth-container">
      <div class="auth-card">
        <!-- 頂部品牌 -->
        <div class="auth-head d-flex align-items-center gap-3">
          <div class="brand-badge">BL</div>
          <div>
            <div class="brand-title">Balanced Dental Lab</div>
            <!-- 🔄 改這行文字：由「帳號與權限管理」→「登入系統」 -->
            <div class="brand-sub">登入系統</div>
          </div>
        </div>

        <!-- 內容 -->
        <div class="auth-body">
          <!-- 登入 -->
          <template v-if="currentView==='login'">
            <!-- ❌ 移除原本這行標題：
          <h5 class="fw-bold mb-3"><i class="bi bi-box-arrow-in-right me-1"></i>登入系統</h5>
          -->
            <div class="mb-2">
              <label class="form-label">帳號</label>
              <input class="form-control" v-model.trim="loginForm.username" placeholder="Username"
                autocomplete="username" />
            </div>
            <div class="mb-3">
              <label class="form-label">密碼</label>
              <input class="form-control" v-model="loginForm.password" type="password" placeholder="Password"
                autocomplete="current-password" />
            </div>
            <button class="btn btn-brand w-100" @click="login" :disabled="loading">
              <span v-if="!loading">登入</span>
              <span v-else class="spinner-border spinner-border-sm"></span>
            </button>
            <div class="mt-3 text-center small">
              <a class="muted-link me-2" @click.prevent="switchView('register')" href="#">
                <i class="bi bi-person-plus me-1"></i>註冊帳號
              </a>
              <span class="text-secondary">|</span>
              <a class="muted-link ms-2" @click.prevent="switchView('changePassword')" href="#">
                <i class="bi bi-key me-1"></i>修改密碼
              </a>
            </div>
          </template>

          <!-- 註冊 -->
          <template v-else-if="currentView==='register'">
            <h5 class="fw-bold mb-3"><i class="bi bi-person-plus me-1"></i>註冊帳號</h5>
            <div class="mb-2">
              <label class="form-label">帳號</label>
              <input class="form-control" v-model.trim="registerForm.username" placeholder="Username"
                autocomplete="username" />
            </div>
            <div class="mb-2">
              <label class="form-label">密碼（至少8碼，含英數）</label>
              <input class="form-control" v-model="registerForm.password" type="password" placeholder="Password"
                autocomplete="new-password" />
            </div>
            <div class="mb-2">
              <label class="form-label">姓名</label>
              <input class="form-control" v-model.trim="registerForm.name" placeholder="姓名" />
            </div>
            <div class="mb-3">
              <label class="form-label">角色</label>
              <input class="form-control" v-model="registerForm.role" disabled />
              <div class="form-text">預設為 staff，如需 admin 請由管理者於後台調整。</div>
            </div>
            <div class="d-grid gap-2 d-md-flex">
              <button class="btn btn-outline-brand flex-fill" @click="switchView('login')">
                <i class="bi bi-arrow-left"></i> 回登入
              </button>
              <button class="btn btn-brand flex-fill" @click="register" :disabled="loading">
                <span v-if="!loading">註冊</span>
                <span v-else class="spinner-border spinner-border-sm"></span>
              </button>
            </div>
          </template>

          <!-- 修改密碼 -->
          <template v-else-if="currentView==='changePassword'">
            <h5 class="fw-bold mb-3"><i class="bi bi-key me-1"></i>修改密碼</h5>
            <div class="mb-2">
              <label class="form-label">帳號</label>
              <input class="form-control" v-model.trim="changePasswordForm.username" placeholder="Username"
                autocomplete="username" />
            </div>
            <div class="mb-2">
              <label class="form-label">舊密碼</label>
              <input class="form-control" v-model="changePasswordForm.oldPassword" type="password" placeholder="舊密碼"
                autocomplete="current-password" />
            </div>
            <div class="mb-3">
              <label class="form-label">新密碼（至少8碼，含英數）</label>
              <input class="form-control" v-model="changePasswordForm.newPassword" type="password" placeholder="新密碼"
                autocomplete="new-password" />
            </div>
            <div class="d-grid gap-2 d-md-flex">
              <button class="btn btn-outline-brand flex-fill" @click="switchView('login')">
                <i class="bi bi-arrow-left"></i> 回登入
              </button>
              <button class="btn btn-brand flex-fill" @click="changePassword" :disabled="loading">
                <span v-if="!loading">修改密碼</span>
                <span v-else class="spinner-border spinner-border-sm"></span>
              </button>
            </div>
          </template>

          <!-- 訊息區 -->
          <div v-if="errorMessage" class="alert alert-danger mt-3 mb-0">
            <i class="bi bi-exclamation-triangle-fill me-1"></i>{{ errorMessage }}
          </div>
          <div v-if="successMessage" class="alert alert-success mt-3 mb-0">
            <i class="bi bi-check-circle-fill me-1"></i>{{ successMessage }}
          </div>

          <!-- 底部時間 -->
          <div class="text-center mt-3 small clock">
            <i class="bi bi-clock me-1"></i>{{ currentTime }}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/vue@3.3.4/dist/vue.global.js"></script>
  <script>
    const HOME_PAGE = 'home.html';

    Vue.createApp({
      data() {
        return {
          currentView: 'login',
          currentTime: '',
          loading: false,
          errorMessage: '',
          successMessage: '',
          loginForm: { username: '', password: '' },
          registerForm: { username: '', password: '', name: '', role: 'staff' },
          changePasswordForm: { username: '', oldPassword: '', newPassword: '' },
        };
      },
      methods: {
        updateTime() {
          const d = new Date();
          this.currentTime = `${d.getFullYear()}-${this.p2(d.getMonth() + 1)}-${this.p2(d.getDate())} ${this.p2(d.getHours())}:${this.p2(d.getMinutes())}`;
        },

        // 格式化數字為兩位數
        p2(n) {
          return n < 10 ? `0${n}` : `${n}`;
        },




        switchView(view) {
          this.errorMessage = '';
          this.successMessage = '';
          this.currentView = view;
        },
        async login() {
          this.errorMessage = '';
          this.successMessage = '';
          const { username, password } = this.loginForm;
          if (!username || !password) {
            this.errorMessage = '請輸入帳號與密碼';
            return;
          }
          this.loading = true;
          try {
            const res = await fetch('http://localhost:8080/api/logins/login', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(this.loginForm)
            });
            if (!res.ok) throw new Error(await res.text());
            const data = await res.json();

            const name = String(data.name || '').trim();
            const rawRole = String(data.role || '').trim().toLowerCase();
            const roleMap = { 'admin': 'admin', 'administrator': 'admin', 'superadmin': 'admin', 'root': 'admin', 'staff': 'staff', 'user': 'staff' };
            const role = roleMap[rawRole] || rawRole;
            const empNo = data.empNo || '';

            localStorage.setItem('user', JSON.stringify({ username: name, role, empNo }));
            localStorage.setItem('loginUser', name);
            localStorage.setItem('loginRole', role);
            localStorage.setItem('loginEmpNo', empNo);

            window.location.replace(HOME_PAGE);
          } catch (err) {
            this.errorMessage = err.message || '登入失敗';
          } finally {
            this.loading = false;
          }
        },
        async register() {
          this.errorMessage = '';
          this.successMessage = '';
          const { username, password } = this.registerForm;
          if (!username?.trim() || !password?.trim()) {
            this.errorMessage = '帳號與密碼不可為空';
            return;
          }
          if (/\s/.test(username) || /\s/.test(password)) {
            this.errorMessage = '帳號與密碼不可包含空白字元';
            return;
          }
          const strong = /^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]{8,}$/;
          if (!strong.test(password)) {
            this.errorMessage = '密碼需至少 8 碼，且必須包含英文字母與數字';
            return;
          }
          this.loading = true;
          try {
            const res = await fetch('http://localhost:8080/api/logins/register', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(this.registerForm)
            });
            if (!res.ok) throw new Error(await res.text());
            const data = await res.json();
            this.successMessage = `註冊成功！員工編號：${data.empNo || ''}`;
            setTimeout(() => this.switchView('login'), 1500);
          } catch (err) {
            this.errorMessage = err.message || '註冊失敗';
          } finally {
            this.loading = false;
          }
        },
        async changePassword() {
          this.errorMessage = '';
          this.successMessage = '';
          const { username, oldPassword, newPassword } = this.changePasswordForm;
          if (!username?.trim() || !oldPassword || !newPassword) {
            this.errorMessage = '請完整輸入帳號、舊密碼與新密碼';
            return;
          }
          const strong = /^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]{8,}$/;
          if (!strong.test(newPassword)) {
            this.errorMessage = '新密碼需至少 8 碼，且必須包含英文字母與數字';
            return;
          }
          this.loading = true;
          try {
            const res = await fetch('http://localhost:8080/api/logins/change-password', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(this.changePasswordForm)
            });
            if (!res.ok) throw new Error(await res.text());
            await res.json();
            this.successMessage = '密碼修改成功！';
            setTimeout(() => this.switchView('login'), 1200);
          } catch (err) {
            this.errorMessage = err.message || '修改密碼失敗';
          } finally {
            this.loading = false;
          }
        },
      },
      mounted() {
        const userObj = localStorage.getItem('user');
        const legacyUser = localStorage.getItem('loginUser');
        if (userObj || legacyUser) {
          window.location.replace(HOME_PAGE);
          return;
        }
        this.updateTime();  // 初始化時也更新一次
        this.timeInterval = setInterval(this.updateTime, 1000); // 每秒更新一次時間
      }
    }).mount('#app');
  </script>
</body>

</html>